---
title: "Clean code for all lakes"
format: html
editor: visual
---

## 1. Data for response diversity

```{r}
#| eval: false
# rm(list = ls())
#removes all variables from the current environment, not necessary for what I am doing here
library(tidyverse)
library(patchwork)
library(ggtext)
library(mgcv)
library(gratia)
#library(hypervolume)
library(here)
library(readr)

# function includes lakeColors
source(here("color-and-functions.R"))

# load final dataset
df_final_no_electro <- read_rds("/home/sophie/Dokumente/Master Thesis R/Master Thesis Analysis/df_final_ne.rds")

```

## 2. Calculating Response Diversity for all lakes

First trying it with nested data. Otherwise, doing a for loop or a function

```{r}
# df_final_ne does not include the data from electro fishing -> different number of fish species per lake

# change that presence and abundance are in one column with one column for value
nets_df_final <- df_final_no_electro |> 
  pivot_longer(
    cols = c("Abundance", "Presence"), 
    names_to = "Parameter", 
    values_to = "value"
  )

# make list of all lakes
lakes_list <- nets_df_final |> 
  distinct(Lake) |> 
  pull(Lake)

# later included inside the loop
# species_list <- nets_df_final |> 
#   distinct(Species) |> 
#   pull(Species)

# make empty lists for the new data provided by the loop
gam_output <- list()
model_prediction <- list()
derivatives <- list()

# working with an abundance subset of this dataset
 
# if else statement in loop would be a possibility
abu_nets_df_final <- nets_df_final |> 
  filter(Parameter == "Abundance")


# make temperature gradient for the prediction
temp_gradient <- data.frame(mean_last_7days = seq(from = min(abu_nets_df_final$mean_last_7days, na.rm = TRUE), to = max(abu_nets_df_final$mean_last_7days, na.rm = TRUE), by = 0.02))


#loop 
# for (i in lakes_list){
#   presence_lake <- abu_nets_df_final |> 
#     filter(Lake == i)
#   species_list <- presence_lake |> 
#     distinct(Species) |> 
#     pull(Species)
#   saveRDS(species_list,paste0("test_species/species_", i,".rds"))
#   for (j in species_list){ #looping through all species occuring in this lake
#     gam_output <- gam(data = presence_lake |> filter(Species== j), value ~ s(mean_last_7days, k = 3)) #GAM per species in all lakes
#     model_prediction[[j]] <- predict.gam(gam_output, temp_gradient, type = "response", se.fit = TRUE)$fit #saving model predictions in RDS
#     saveRDS(model_prediction,paste0("Predictions2/predictions_",i,".rds"))
#     derivatives[[j]] <- derivatives(gam_output) #making derivatives and saving them in a RDS
#     saveRDS(model_prediction,paste0("Derivatives2/derivatives_",i,".rds"))
#   }
# 
# }
#   

# looping through every lake, filtering it by the current lake and pulling a list of in this lake occuring species

gam_output <- list()
model_prediction <- list()
derivatives <- list()

df_small <- abu_nets_df_final |> 
  filter(Lake %in% c("Biel", "Brienz", "Walen"))

small_lakes <- df_small |> 
  distinct(Lake) |> 
  pull(Lake)

for (i in small_lakes){
  presence_lake <- df_small |>
    filter(Lake == i)
  species_list <- presence_lake |>
    distinct(Species) |>
    pull(Species)
  #saveRDS(species_list,paste0("test_species/species_", i,".rds"))
  for (j in species_list){ #looping through all species occuring in this lake
    data <- presence_lake |> 
      filter(Species == j)
    gam_output[[j]] <- gam(data = data, value ~ s(mean_last_7days, k = 3)) #GAM per species in all lakes
    model_prediction[[j]] <- predict.gam(gam_output[[j]], temp_gradient, type = "response", se.fit = TRUE)$fit #saving model predictions in RDS
    saveRDS(model_prediction[[j]], paste0("pred_test/predictions_",i,"_",j,".rds"))
    derivatives[[j]] <- derivatives(gam_output[[j]]) #making derivatives and saving them in a RDS
    saveRDS(derivatives[[j]], paste0("deriv_test/derivatives_",i,"_",j,".rds"))
  }

}

path_pred <- "/home/sophie/Dokumente/Master Thesis R/response-diversity-in-swiss-lakes/pred_test"

#path_deriv <- "/home/sophie/Dokumente/Master Thesis R/response-diversity-in-swiss-lakes/deriv_test"


predictions_list <-list.files(path_pred)

predictions_test <- list()

for (i in small_lakes){
  predictions_test <- predictions_list |> 
  as_tibble() |> 
  filter(str_detect(value, i)) |> 
  pull(value)
  
}

predictions_list |> 
  as_tibble() |> 
  filter(str_detect(value, "Biel")) |> 
  pull(value)
predictions_biel_list <- predictions_list[1:22]

biel_predictions <- list()

for (i in predictions_biel_list){
  biel_predictions[[i]] <- readRDS(paste0(path,"/", i))
}

biel_df <- biel_predictions |> 
  bind_cols()
  

biu_abramis <- readRDS("pred_test/predictions_Biel_Abramis_brama.rds")

df_small |> 
  filter(Lake == "Biel") |> 
  distinct(Species)
biu |> 
  names()

walen <- readRDS("pred_test/predictions_Walen.rds")

walen |> 
  names()

df_small |> 
  filter(Lake == "Walen") |> 
  distinct(Species)

brienz <- readRDS("pred_test/predictions_Brienz.rds")

brienz |> 
  names()



#testing first part, works perfectly, why is list of species longer then?
#first part works perfectly, second part only works when species_list is written outside of the loop, for one lake
#testing one lake,it should work


###TO DO ###
# change name to abundance: done 
#response diversity berechnen: done
# plots ausprobieren: works
#. species list is always 97 long: specifying the second for loop?
#solved: same loop but new df_final_ne without electro data, now number of species are the right number. 

# make for loop for presence/absence data

# list of problems:
#1. adding negbin not working
#2. still too many species in list
#3. name temp column is strange

# next steps_
#solve problems
#make one data frame with model_predictions and derivative
#is there a faster way to generate the df for lake plotting?


```

### Dfs for plotting

```{r}
#trying to for loop to make the DFs for plotting
#lose Ideen

# preparing data sets for plotting

directory <- "/home/sophie/Dokumente/Master Thesis R/response-diversity-in-swiss-lakes/deriv_test"

# Create an empty list to store the loaded objects
loaded_objects <- list()

# Create a vector of file names in the directory
file_names <- list.files(directory, pattern = "\\.rds$", full.names = TRUE)

# Iterate over each file name and load the RDS file
for (file_name in file_names) {
  loaded_object <- readRDS(file_name)
  loaded_objects[[file_name]] <- loaded_object
   saveRDS(model_prediction,paste0("deriv_test/derivatives_",i,".rds")
}

for (file in file_path){
  df_i <- readRDS("pred_test/derivatives", i, ".rds")
}

left_join()
cols = everything()

```

```{r}
# make df for rdiv, model predictions and derivatives

deriv_const <- readRDS("Derivatives2/derivatives_Constance.rds")

#make df with derviatives data and use this to calculate resposne diversity
resp_div_const <- deriv_const |> 
  bind_cols() #make data frame out of it

resp_div_const$rdiv<-apply(resp_div_const[,c(1:92)], 1, resp_div, sign_sens = F)
resp_div_const$sign<-apply(resp_div_const[,c(1:92)], 1, resp_div, sign_sens = T)
resp_div_const$Med<-median(resp_div_const$rdiv)

df_rdiv_const <- cbind(resp_div_const, temp_gradient)

# make df with model predictions and derivatives
const <- readRDS("Predictions2/predictions_Constance.rds")

pred_const <- const |> 
  bind_cols()

#make df long
df_pred_const <- pred_const |> 
  pivot_longer(
    cols = c(1:92),
    names_to = "Species", 
    values_to = "model_prediction")

# make df for derivative data

df_deriv_const <- deriv_const |> 
  bind_cols()

df_deriv_const <- df_deriv_const |> 
  pivot_longer(
    cols = c(1:92),
    names_to = "Species", 
    values_to = "derivatives")

df_pred_deriv_const <- df_pred_const |> 
  left_join(df_deriv_const)


#add temp
df_pred_const <- cbind(pred_const, temp_gradient)
pred_const$mean_last_7days <- temp_gradient



df_deriv_const$mean_last_7days <- temp_gradient

df_deriv_const <- df_deriv_const |> 
  pivot_longer(
    cols = c(1:97),
    names_to = "Species", 
    values_to = "derivatives")
```

#### Plotting

```{r}
##plotting test constance
fig_a <- ggplot() +
  theme_classic(base_size = 14) +
  labs(x = "Temperature", y = "Abundance", tag = "a)") +
  geom_hline(
    yintercept = 0,
    lty = 2) +
  geom_line(data = df_pred_const, mapping = aes(x = mean_last_7days$mean_last_7days, y = model_prediction, color = Species)) +
  scale_colour_manual(values = lakeColors, guide = NULL)
  # lims(y = c(ymin_p, ymax_p))

fig_a


# plotting derivatives of presence

fig_b <- ggplot(data = df_deriv_const, mapping = aes(x = mean_last_7days$mean_last_7days, y = derivatives, color = Species)) +
  theme_classic(base_size = 14) +
  labs(x = "Temperature", y = "Derivative", tag = "c)") +
  geom_hline(
    yintercept = 0,
    lty = 2) +
  geom_line() +
  scale_colour_manual(values = lakeColors, guide = NULL)
  # lims(y = c(dmin, dmax))

fig_b

# plotting dissimilarity of derivatives
fig_c <- ggplot(data = resp_div_const, mapping = aes(x = mean_last_7days$mean_last_7days, y = rdiv)) +
  theme_classic(base_size = 14) +
  labs(x = NULL, y = "Dissimilarity", tag = "e)") +
  geom_hline(yintercept = resp_div_const$Med, lty = 2) +
  geom_line()
  # lims(y = c(rmin_p, rmax_p))

fig_c

# plot divergence

fig_d <- ggplot(data = resp_div_const, mapping = aes(x = mean_last_7days$mean_last_7days, y = sign)) +
  theme_bw(base_size = 14) +
  labs(x = "Temperature", y = "Sign", tag = "g)") +
  geom_line()
  # lims(y = c(smin, smax))

fig_d
```

r
